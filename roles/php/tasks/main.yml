---
# roles/php/tasks/main.yml

- name: Add ppa:ondrej/php repository
  become: true
  apt_repository:
    repo: ppa:ondrej/php

- name: Install PHP packages
  become: true
  apt:
    name:
      - php7.3-cli
      - php7.3-curl
      - php7.3-fpm
      - php7.3-xml
      - php7.3-mysql
      - php7.3-mbstring
      - php7.3-zip
    state: latest

- name: Set date.timezone for CLI
  become: true
  lineinfile:
    dest: /etc/php/7.3/cli/php.ini
    regexp: "date.timezone ="
    line: "date.timezone = Europe/Paris"

- name: Set date.timezone for FPM
  become: true
  lineinfile:
    dest: /etc/php/7.3/fpm/php.ini
    regexp: "date.timezone ="
    line: "date.timezone = Europe/Paris"
  notify:
    - restart php-fpm

- name: Download composer
  get_url:
    url: https://getcomposer.org/installer
    dest: /tmp/installer

- name: Install composer
  become: true
  command: "{{ item }}"
  with_items:
    - "php /tmp/installer"
    - mv composer.phar /usr/local/bin/composer

- name: Remove composer installer
  file:
    path: "/tmp/installer"
    state: absent

- name: Set permissions on Composer
  become: true
  file:
    path: /usr/local/bin/composer
    mode: "a+x"
